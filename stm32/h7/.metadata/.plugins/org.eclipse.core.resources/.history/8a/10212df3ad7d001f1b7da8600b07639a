/*
 * mac.c
 *
 *  Created on: Sep 28, 2024
 *      Author: zero
 */

#include "stm32h7xx.h"

void init_mac_clk(void)
{
	RCC->APB4ENR |= (1<<1);
	RCC->AHB1ENR |= (1<<17)|(1<<16)|(1<<15);

}


void init_mac_pin(void)
{
	//PC1,PC4,PC5
	GPIOC->MODER &= ~((0b11<<10)|(0b11<<8)|(0b11<<2));
	GPIOC->MODER |= (0b10<<10)|(0b10<<8)|(0b10<<2);
	GPIOC->AFR[0] &= ~((0b1111<<20)|(0b1111<<16)|(0b1111<<4));
	GPIOC->AFR[0] |= (11<<20)|(11<<16)|(11<<4);

	//PA2,PA7
	GPIOA->MODER &= ~((0b11<<14)|(0b11<<4));
	GPIOA->MODER |= (0b10<<14)|(0b10<<4);
	GPIOA->AFR[0] &= ~((0b1111<<28)|(0b1111<<8));
	GPIOA->AFR[0] |= (11<<28)|(11<<8);

	//PB11
	GPIOB->MODER &= ~(0b11<<22);
	GPIOB->MODER |= (0b10<<22);
	GPIOB->AFR[1] &= ~((0b1111<<12));
	GPIOB->AFR[1] |= (11<<12);

	//PG13,PG14
	GPIOG->MODER &= ~((0b11<<28)|(0b11<<26));
	GPIOG->MODER |= (0b10<<28)|(0b10<<26);
	GPIOG->AFR[1] &= ~((0b1111<<24)|(0b1111<<20));
	GPIOG->AFR[1] |= (11<<24)|(11<<20);

	//

}


void write_phy(unsigned char addr, unsigned char reg, unsigned short value)
{
  while (ETH->MACMDIOAR & )
    ;
  mac->macmiiar.bit.pa = addr;
  mac->macmiiar.bit.mr = reg;
  mac->macmiiar.bit.mw = 1;
  mac->macmiidr.bit.md = value;

  mac->macmiiar.bit.mb = 1;
  while (1 == mac->macmiiar.bit.mb)
    ;
}


void init_mac(void)
{
	SYSCFG->PMCR &= ~(0b111<<21);
	SYSCFG->PMCR |= (0b100<<21);

	ETH->DMAMR |= (1<<0);
	while(!(ETH->DMAMR & (1<<0)));

	ETH->MACMDIOAR &= ~(0b111<<8);
	ETH->MACMDIOAR |= 0b100;


}
